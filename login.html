<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width,initial-scale=1" name="viewport">
  <title>çµæœå—ã‘å–ã‚Šãƒšãƒ¼ã‚¸</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.js"></script>
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background-color: #fff;
      padding: 2em;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.1);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    h1 {
      margin-bottom: 1.5em;
      color: #333;
    }
    label {
      display: block;
      text-align: left;
      margin-top: 1em;
      font-weight: 700;
      color: #555;
    }
    input {
      width: 100%;
      padding: .7em;
      margin-top: .3em;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      margin-top: 1.5em;
      padding: .8em 1.5em;
      font-size: 1em;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      transition: background-color .3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    #status {
      margin-top: 1em;
      color: #333;
      font-size: .9em;
    }
    #status a {
      color: #007bff;
      text-decoration: underline;
    }
    #status a:hover {
      color: #0056b3;
    }
    pre {
      text-align: left;
      background: #f7f7f7;
      padding: 1em;
      border-radius: 6px;
      font-size: .85em;
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>çµæœã‚’å—ã‘å–ã‚‹ï¼</h1>
    <form onsubmit="handleLogin(event)">
      <label for="number">ç•ªå· (1ã€œ4æ¡ã®åŠè§’æ•°å­—):</label>
      <input id="number" name="number" pattern="^\d{1,4}$" required title="1ã€œ4æ¡ã®åŠè§’æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
      <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (4æ¡ã®åŠè§’æ•°å­—):</label>
      <input id="password" name="password" pattern="^\d{4}$" required title="4æ¡ã®åŠè§’æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
      <button type="submit">é€ä¿¡</button>
    </form>
    <p id="status"></p>
    <p id="contact-link" style="display:none;margin-top:1em;font-size:.9em">
      ãŠå›°ã‚Šã§ã™ã‹ï¼Ÿ<br>
      <a href="https://forms.gle/653SgnhWdSB2ABk58" target="_blank">ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ </a>ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚
    </p>
    <p id="pdf-link" style="display:none;margin-top:1em;font-size:.9em">
      â€»ã‚ãªãŸã®çµæœã¯ã™ã§ã«ä¸‹ã«æ›¸ã‹ã‚Œã¦ã‚ã‚Šã¾ã™ã€‚<br>
      çµæœç”¨ç´™ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã”è¦§ã«ãªã‚ŠãŸã„å ´åˆã¯ã€<br>
      <a href="https://drive.google.com/file/d/12OyZ564bCkghZswXcJsK2VGt81xDqE-2/view?usp=sharing" target="_blank">
        ã“ã¡ã‚‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
      </a>
    </p>
  </div>

  <!-- JavaScriptãŒç„¡åŠ¹ãªå ´åˆã«è¡¨ç¤º -->
  <noscript>
    <div style="padding:1em; text-align:center; color:red; font-weight:bold;">
      ã€æ³¨æ„ã€‘JavaScriptãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚<br>
      ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‹ã‚‰JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚
    ã€€è©³ã—ã„ã‚„ã‚Šæ–¹ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã®ã§ã€å„è‡ªã§èª¿ã¹ã¦ãã‚Œã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚
    </div>
  </noscript>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbySpS77YtVFI8Cv91PvDTsdvuAKnVOqLTgSwfGgV0bXIcs-AsHHmaW1KLraO3I5Zk4/exec';
    const PDF_TEMPLATE_URL = 'https://sh-shaken.github.io/çµæœç”¨ç´™æœ¬ç‰©åŸæœ¬webç”¨.pdf';
    const FONT_URL = 'https://sh-shaken.github.io/fonts/NotoSansJP-Bold.ttf';

    function handleLogin(event) {
      event.preventDefault();
      const status = document.getElementById('status');
      const contact = document.getElementById('contact-link');
      const pdfLink = document.getElementById('pdf-link');

      if (!navigator.onLine) {
        status.textContent = "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Wi-Fiã‚„é€šä¿¡çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        contact.style.display = 'block';
        pdfLink.style.display = 'block';
        return;
      }

      const number = document.getElementById('number').value.trim().replace(/^0+/, '');
      const password = document.getElementById('password').value.trim();
      status.textContent = "ç•ªå·ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç…§åˆã—ã¦ã„ã¾ã™...";
      contact.style.display = 'none';
      pdfLink.style.display = 'none';

      const existing = document.getElementById('jsonpScript');
      if (existing) existing.remove();

      const script = document.createElement('script');
      script.id = 'jsonpScript';
      script.src = `${GAS_URL}?id=${encodeURIComponent(number)}&pw=${encodeURIComponent(password)}&callback=handleJSONPResponse`;

      script.onerror = () => {
        status.textContent = "ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
        contact.style.display = 'block';
        pdfLink.style.display = 'block';
      };

      document.body.appendChild(script);
    }

    async function handleJSONPResponse(result) {
      const status = document.getElementById('status');
      const contact = document.getElementById('contact-link');
      const pdfLink = document.getElementById('pdf-link');

      if (!result.success) {
        status.textContent = "ç•ªå·ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚";
        contact.style.display = 'block';
        pdfLink.style.display = 'block';
        return;
      }

      const logLines = Object.entries(result)
        .filter(([k]) => k !== "success")
        .map(([key, val]) => `${key}: ${val}`)
        .join("\n");

      const pre = document.createElement('pre');
      pre.textContent = "ã€å–å¾—ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚°ã€‘\n" + logLines;
      document.querySelector('.container').appendChild(pre);

      try {
        const url = await generatePDF(result);

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + ä»£æ›¿ãƒªãƒ³ã‚¯
        status.innerHTML = `
          çµæœã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼å¿ƒç†ãƒ†ã‚¹ãƒˆã«ã”å”åŠ›ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼<br><br>
          <small>â€»LINEã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹å ´åˆã€PDFãŒè‡ªå‹•ã§é–‹ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</small><br>
          <a href="${url}" target="_blank">ğŸ‘‰ PDFãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã“ã¡ã‚‰ã‚’ã‚¿ãƒƒãƒ—</a>
        `;
      } catch (err) {
        console.error("PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
        status.textContent = "çµæœPDFã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        contact.style.display = 'block';
        pdfLink.style.display = 'block';
      }
    }

    async function generatePDF(userData) {
      const [pdfBytes, fontBytes] = await Promise.all([
        fetch(PDF_TEMPLATE_URL).then(res => res.arrayBuffer()),
        fetch(FONT_URL).then(res => res.arrayBuffer())
      ]);

      const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
      pdfDoc.registerFontkit(window.fontkit);
      const customFont = await pdfDoc.embedFont(fontBytes);
      const pages = pdfDoc.getPages();

      const positionsPage1 = {
        ID:    { x: 503, y: 772 },
        å·¦è„³:  { x: 200, y: 648 },
        å³è„³:  { x: 350, y: 648 },
        å­¦ç”Ÿ:  { x: 62.5,  y: 310 },
      };

      const positionsPage2 = {
        CP:  { x: 90, y: 505 },
        NP:  { x: 90, y: 460 },
        A:   { x: 90, y: 418 },
        FC:  { x: 90, y: 377 },
        AC:  { x: 90, y: 335 },
      };

      const page1 = pages[0];
      for (const key in positionsPage1) {
        const val = userData[key];
        if (val !== undefined) {
          page1.drawText(String(val), {
            x: positionsPage1[key].x,
            y: positionsPage1[key].y,
            size: (key === 'ID' || key === 'å­¦ç”Ÿ') ? 14 : 40,
            font: customFont,
            color: PDFLib.rgb(1, 0, 0),
          });
        }
      }

      if (pages.length >= 2) {
        const page2 = pages[1];
        for (const key in positionsPage2) {
          const val = userData[key];
          if (val !== undefined) {
            page2.drawText(String(val), {
              x: positionsPage2[key].x,
              y: positionsPage2[key].y,
              size: 20,
              font: customFont,
              color: PDFLib.rgb(1, 0, 0),
            });
          }
        }
      }

      const pdfBytesOut = await pdfDoc.save();
      const blob = new Blob([pdfBytesOut], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);

      // è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆãŸã ã—LINEã§ã¯å‹•ä½œã—ãªã„ï¼‰
      try {
        const a = document.createElement('a');
        a.href = url;
        a.download = `${userData['ID'] || 'output'}.pdf`;
        a.click();
      } catch {}

      // URLã‚’è¿”ã™ï¼ˆä¸Šã§ãƒªãƒ³ã‚¯è¡¨ç¤ºã«ä½¿ç”¨ï¼‰
      return url;
    }
  </script>
</body>
</html>
